<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.avengers.musinsa.mapper.OrderMapper">
    <!--주문자 기본정보 조회 -->
    <select id="getUserInfo" resultType="com.avengers.musinsa.domain.order.dto.UserInfoDTO" parameterType="Long">
        SELECT u.user_id                                   as userId,
               u.user_name                                 as userName,
               ua.phone_number                             as phoneNumber,
               ua.address_line1 || ' ' || ua.address_line2 AS location
        FROM USERS u
                 join user_addresses ua ON u.user_id = ua.user_id
        WHERE u.user_id = #{userId}
          AND ua.is_default = 1
    </select>

    <insert id="createShipment" parameterType="com.avengers.musinsa.domain.order.dto.request.OrderCreateRequest">
        <selectKey keyProperty="shipping.shippingId" resultType="long" order="BEFORE">
            SELECT seq_shipments.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO SHIPMENTS (SHIPPING_ID,
        SCHEDULED_DELIVERY_INFORMATION_ID,
        SHIPPING_REQUEST_TYPE_ID,
        SHIPPING_STATUS_ID,
        SHIPPING_INQUIRY,
        RECIPIENT_NAME,
        RECIPIENT_PHONE,
        RECIPIENT_ADDRESS,
        SHIPPING_DIRECT_REQUEST,
        POSTAL_CODE)
        VALUES (
        #{shipping.shippingId},
        #{shipping.scheduledDeliveryInformationId},
        #{shipping.deliveryRequestId},
        #{shipping.shippingStatusId},
        NULL,
        #{shipping.recipientName},
        #{shipping.recipientPhone},
        #{shipping.recipientAddress},
        #{shipping.shippingDirectRequest},
        #{shipping.postalCode})
    </insert>

    <insert id="createOrder">
        <selectKey keyProperty="payment.orderId" resultType="long" order="BEFORE">
            SELECT SEQ_ORDERS.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO ORDERS (
        ORDER_ID,
        USER_ID,
        USER_ADDRESS_ID,
        SHIPPING_ID,
        PAYMENT_METHOD_ID,
        ORDER_CODE,
        TOTAL_PRICE,
        ORDER_DISCOUNT_AMOUNT,
        FINAL_PRICE,
        ORDER_STATUS)
        VALUES(
        #{payment.orderId},
        #{userId},
        #{userAddressId},
        #{shippingId},
        #{payment.paymentMethodId},
        NULL,
        #{payment.totalAmount},
        #{payment.discountAmount},
        #{payment.totalAmount} - #{payment.discountAmount},
        'PAID'
        )
    </insert>

    <insert id="createOrderItems">
        INSERT INTO ORDER_ITEMS
        (ORDER_ITEM_ID, PRODUCT_ID, ORDER_ID, QUANTITY, UNIT_PRICE, TOTAL_PRICE)
        VALUES (SEQ_ORDER_ITEMS.NEXTVAL, #{product.productId}, #{orderId}, #{product.quantity}, #{product.price},
                #{product.price} * #{product.quantity})
    </insert>
    <!-- 배송지 목록 조회 -->


    <!-- 주문 상품 리스트(상품이미지, 사이즈, 개수, 금액) -->


    <!-- 상품별 할인 금액 계산 (브랜드 자체 할인) -->


    <!-- 주문하기 -->


</mapper>