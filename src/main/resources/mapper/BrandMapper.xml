<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.avengers.musinsa.mapper.BrandMapper">
    <select id="selectRecentVisitedBrands" parameterType="long" resultType="com.avengers.musinsa.domain.brand.dto.BrandDto">
        SELECT
            brandId,
            brandName,
            brandEngName,
            brandImageUrl
        FROM (
                 SELECT DISTINCT
                     b.BRAND_ID AS brandId,
                     b.BRAND_NAME_KR AS brandName,
                     b.BRAND_NAME_ENG AS brandEngName,
                     b.BRAND_IMAGE AS brandImageUrl,
                     MAX(sbl.SEARCH_DATETIME) AS maxViewTime
                 FROM SEARCH_BRAND_LOGS sbl
                          JOIN brands b ON sbl.SEARCH_BRAND_ID = b.BRAND_ID
                 WHERE sbl.USER_ID = #{userId}
                 GROUP BY b.BRAND_ID, b.BRAND_NAME_KR, b.BRAND_NAME_ENG, b.BRAND_IMAGE
                 ORDER BY maxViewTime DESC
             )
    </select>

    <!--카테고리 - 브랜드 목록 전체 조회-->
    <select id="getBrandList"
            resultType="com.avengers.musinsa.domain.brand.dto.response.BrandResponse">
        SELECT brand_id as brandId,
               brand_name_kr as brandNameKr,
               brand_name_eng as brandNameEn,
               brand_image as brandImage
        FROM brands
        ORDER BY BRAND_LIKES DESC, brand_name_kr ASC
    </select>

    <select id="findBrandsByEnglishFirstLetter"
            resultType="com.avengers.musinsa.domain.brand.dto.response.BrandResponse">
        SELECT brand_id as brandId,
               brand_name_kr as brandNameKr,
               brand_name_eng as brandNameEn,
               brand_image as brandImage
        FROM brands
        WHERE brand_name_eng LIKE CONCAT(#{brandFirstLetter}, '%')
        ORDER BY brand_name_eng
    </select>

    <select id="findBrandsByKoreanFirstLetter"
            resultType="com.avengers.musinsa.domain.brand.dto.response.BrandResponse">
        SELECT brand_id as brandId,
               brand_name_kr as brandNameKr,
               brand_name_eng as brandNameEn,
               brand_image as brandImage
        FROM brands
        WHERE brand_first_letter_kr = #{brandFirstLetter}
        ORDER BY brand_name_kr
    </select>


    <!--첫 좋아요 여부를 null 체크(레코드 확인)-->
    <select id="getUserBrandStatus"
            resultType="com.avengers.musinsa.domain.brand.dto.response.UserBrandStatus">
        SELECT ubl.liked AS liked
        FROM BRANDS b
        LEFT JOIN USER_BRAND_LIKES ubl
        ON b.BRAND_ID = ubl.BRAND_ID AND ubl.USER_ID = #{userId}
        WHERE b.BRAND_ID = #{brandId}
    </select>

    <!--브랜드 최초 좋아요 하기(레코드 추가)-->
    <insert id="insertUserBrandLike">
        INSERT INTO user_brand_likes (user_brand_like_id, user_id, brand_id, liked) VALUES (user_brand_likes_seq.NEXTVAL,#{userId}, #{brandId}, 1)
    </insert>

    <!--브랜드 테이블의 좋아요 수+1-->
    <update id="plusBrandLikeCnt">
        UPDATE BRANDS
        SET BRAND_LIKES = BRAND_LIKES + 1
        WHERE BRAND_ID = #{brandId}
    </update>

    <!--브랜드 테이블의 좋아요 수-1-->
    <update id="minusBrandLikeCnt">
        UPDATE BRANDS
        SET BRAND_LIKES = BRAND_LIKES - 1
        WHERE BRAND_ID = #{brandId}
    </update>


    <!--레코드 추가 후 회원과 브랜드의 현재 좋아요 상태를 반환-->
    <select id="getIsLikedBrand"
            resultType="com.avengers.musinsa.domain.brand.dto.response.BrandLikeResponse">
        SELECT brand_id as brandId,
               user_id as userId,
               liked as liked
        FROM USER_BRAND_LIKES
        WHERE BRAND_ID = #{brandId} and USER_ID = #{userId}
    </select>

    <!--회원브랜드좋아요 테이블 liked 0 ↔ 1-->
    <update id="switchBrandLike">
        UPDATE USER_BRAND_LIKES
        SET liked = CASE liked
                        WHEN 0 THEN 1
                        WHEN 1 THEN 0
            END
        WHERE user_id = #{userId} AND brand_id = #{brandId}
    </update>

    <!--브랜드 테이블 좋아요 수 업데이트-->
    <update id="updateBrandLikeCnt">
        UPDATE BRANDS
        SET BRAND_LIKES = BRAND_LIKES +
                          CASE
                              WHEN (SELECT liked FROM USER_BRAND_LIKES
                                    WHERE user_id = #{userId} AND brand_id = #{brandId}) = 1 THEN 1
                              ELSE -1
                              END
        WHERE BRAND_ID = #{brandId}
    </update>


    <!--카테고리 - 카테고리 별로 브랜드 목록 조회-->
    <select id="getBrandsByCategoryId"
            resultType="com.avengers.musinsa.domain.brand.dto.response.BrandByCategoryResponse">
        SELECT bc.brand_category_id as brandCategoryId,
               bc.category_name as categoryName,
               b.brand_id as brandId,
               b.brand_name_kr as brandNameKr,
               b.brand_name_eng as brandNameEn,
               b.brand_image as brandImage
        FROM brands b
            JOIN brand_has_categories bhc ON b.BRAND_ID = bhc.BRAND_ID
            JOIN brand_categories bc ON bc.brand_category_id = bhc.brand_category_id
        WHERE bc.BRAND_CATEGORY_ID = #{categoryID}
        ORDER BY BRAND_LIKES DESC, brand_name_kr ASC
    </select>

    <select id="findByBrandName" resultType="com.avengers.musinsa.domain.brand.dto.response.BrandResponse" parameterType="String">
        select b.brand_id as brandId,
               b.brand_name_kr as brandNameKr,
               b.brand_name_eng as brandNameEn,
               b.brand_image as brandImage,
               b.brand_likes as brandLikes

        from brands b
        where brand_name_eng = #{brandName} or brand_name_kr = #{brandName}
    </select>

</mapper>





